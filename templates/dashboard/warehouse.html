{% extends "base.html" %}
{% block title %}Склад — Ростелеком{% endblock %}
{% block extra_css %}
<style>
    body { min-height: 100vh; background: linear-gradient(180deg, #f8f4ff 0%, #fff5f0 100%); font-family: 'Segoe UI', sans-serif; }
    .header { background: linear-gradient(90deg, #7700ff, #ff4f12); padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(119, 0, 255, 0.2); }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .header-user-block { display: flex; align-items: center; gap: 16px; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 16px; border: 1px solid rgba(255,255,255,0.4); }
    .logo { height: 40px; width: auto; }
    .user-login { color: white; font-weight: 600; font-size: 1rem; }
    .logout-btn { padding: 8px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; text-decoration: none; font-weight: 600; }
    .logout-btn:hover { background: rgba(255,255,255,0.35); color: white; }
    .content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; max-height: calc(100vh - 80px); }
    .block { background: white; border-radius: 16px; padding: 28px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; min-height: 520px; cursor: pointer; }
    .block h2 { color: #7700ff; margin-bottom: 16px; font-size: 1.2rem; }
    .table-wrap { flex: 1; overflow: auto; max-height: 620px; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; }
    .data-table th { color: #7700ff; font-weight: 600; position: sticky; top: 0; background: white; }
    .data-table tr:hover { background: #f8f4ff; }
    .empty-msg { color: #999; padding: 24px; text-align: center; }
    .status-ok { color: #2e7d32; }
    .status-low { color: #f57c00; }
    .status-critical { color: #c62828; }
    @media (max-width: 1200px) { .content { grid-template-columns: 1fr; } }
    .map-wrap { flex: 1; overflow: auto; background: #f5f5f5; border-radius: 12px; border: 1px solid #eee; }
    #mapSvg { width: 100%; height: 100%; min-height: 520px; display: block; transform-origin: 0 0; }
    .map-label { fill: #777; font-size: 12px; font-family: 'Segoe UI', Arial, sans-serif; }
    .robot-id-text { fill: #fff; font-weight: 700; font-size: 12px; text-anchor: middle; dominant-baseline: middle; }
    .robot-batt-text { fill: #333; font-size: 11px; text-anchor: middle; }
    .map-controls { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .zoom-btn { padding: 8px 14px; background: linear-gradient(135deg, #7700ff, #ff4f12); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
    .zoom-btn:hover { opacity: 0.9; }
</style>
{% endblock %}
{% block content %}
<header class="header">
    <div class="header-left">
        <div class="header-user-block">
            <img src="{{ url_for('static', filename='img/Rostelekom.png') }}" alt="Ростелеком" class="logo" onerror="this.onerror=null; this.outerHTML='<span class=\'logo-text\' style=\'color:white;font-weight:700;\'>Ростелеком</span>';">
            <span class="user-login">{{ current_user.login }}</span>
        </div>
    </div>
    <a href="{{ url_for('auth.logout') }}" class="logout-btn">Выйти</a>
</header>

<main class="content">
    {% if not view or view == 'robots' %}
    <div class="block" data-url="{{ url_for('dashboard.app_page', app_name='robots') }}">
        <h2>Карта склада с роботами</h2>
        <div class="map-controls">
            <button class="zoom-btn" id="zoomIn">Приблизить</button>
            <button class="zoom-btn" id="zoomOut">Отдалить</button>
            <button class="zoom-btn" id="zoomReset">Сброс</button>
        </div>
        <div class="map-wrap">
            <svg id="mapSvg"></svg>
        </div>
    </div>
    {% endif %}
    
    {% if not view or view == 'inventory' %}
    <div class="block" data-url="{{ url_for('dashboard.app_page', app_name='inventory') }}">
        <h2>История инвентаризации</h2>
        <div class="table-wrap">
            {% if inventory %}
            <table class="data-table">
                <thead>
                    <tr><th>Дата</th><th>Робот</th><th>Товар</th><th>Кол-во</th><th>Зона</th><th>Статус</th></tr>
                </thead>
                <tbody id="inventory-body">
                    {% for inv in inventory %}
                    <tr>
                        <td>{{ inv.scanned_at[:16].replace('T',' ') if inv.scanned_at else '—' }}</td>
                        <td>{{ inv.robot_id or '—' }}</td>
                        <td>{{ inv.product_name or inv.product_id or '—' }}</td>
                        <td>{{ inv.quantity }}</td>
                        <td>{{ inv.zone or '—' }}</td>
                        <td>{{ inv.status or '—' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-msg">Нет данных инвентаризации</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</main>
{% endblock %}
{% block extra_js %}
<script>
    const NS = 'http://www.w3.org/2000/svg';
    const COLS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const ROWS = Array.from({length: 50}, (_, i) => i + 1);
    const CELL_W = 36, CELL_H = 36, LM = 36, TM = 24;
    let gridBuilt = false;

    function buildMapGrid() {
        const svg = document.getElementById('mapSvg');
        if (!svg || gridBuilt) return;
        const W = LM + COLS.length * CELL_W + 16;
        const H = TM + ROWS.length * CELL_H + 16;
        svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

        const grid = document.createElementNS(NS, 'g');
        grid.setAttribute('id', 'grid-layer');
        svg.appendChild(grid);

        for (let j = 0; j <= COLS.length; j++) {
            const x = LM + j * CELL_W;
            const v = document.createElementNS(NS, 'line');
            v.setAttribute('x1', x);
            v.setAttribute('y1', TM);
            v.setAttribute('x2', x);
            v.setAttribute('y2', TM + ROWS.length * CELL_H);
            v.setAttribute('stroke', j % 5 === 0 ? '#bbb' : '#ddd');
            grid.appendChild(v);
        }
        for (let i = 0; i <= ROWS.length; i++) {
            const y = TM + i * CELL_H;
            const h = document.createElementNS(NS, 'line');
            h.setAttribute('x1', LM);
            h.setAttribute('y1', y);
            h.setAttribute('x2', LM + COLS.length * CELL_W);
            h.setAttribute('y2', y);
            h.setAttribute('stroke', i % 5 === 0 ? '#bbb' : '#ddd');
            grid.appendChild(h);
        }

        for (let j = 0; j < COLS.length; j++) {
            const t = document.createElementNS(NS, 'text');
            t.setAttribute('class', 'map-label');
            t.setAttribute('x', LM + j * CELL_W + CELL_W / 2);
            t.setAttribute('y', 14);
            t.setAttribute('text-anchor', 'middle');
            t.textContent = COLS[j];
            grid.appendChild(t);
        }
        for (let i = 0; i < ROWS.length; i++) {
            const t = document.createElementNS(NS, 'text');
            t.setAttribute('class', 'map-label');
            t.setAttribute('x', LM - 10);
            t.setAttribute('y', TM + i * CELL_H + CELL_H / 2 + 4);
            t.setAttribute('text-anchor', 'end');
            t.textContent = ROWS[i];
            grid.appendChild(t);
        }

        const robotsLayer = document.createElementNS(NS, 'g');
        robotsLayer.setAttribute('id', 'robots-layer');
        svg.appendChild(robotsLayer);

        gridBuilt = true;
    }

    function batteryColor(b) {
        if (b === null || b === undefined) return '#888';
        if (b >= 67) return '#2e7d32';
        if (b >= 34) return '#f57c00';
        return '#c62828';
    }

    function renderRobots(robots) {
        buildMapGrid();
        const svg = document.getElementById('mapSvg');
        if (!svg) return;
        let layer = svg.querySelector('#robots-layer');
        if (!layer) {
            layer = document.createElementNS(NS, 'g');
            layer.setAttribute('id', 'robots-layer');
            svg.appendChild(layer);
        }
        while (layer.firstChild) layer.removeChild(layer.firstChild);

        robots.forEach(r => {
            const zone = (r.current_zone || '').toString().trim().toUpperCase();
            const z = zone ? zone[0] : '';
            const col = COLS.indexOf(z);
            const row = parseInt(r.current_row);
            if (col < 0 || isNaN(row) || row < 1 || row > 50) return;
            const x = LM + col * CELL_W + CELL_W / 2;
            const y = TM + (row - 1) * CELL_H + CELL_H / 2;
            const batt = r.battery_level;

            const c = document.createElementNS(NS, 'circle');
            c.setAttribute('cx', x);
            c.setAttribute('cy', y);
            c.setAttribute('r', 14);
            c.setAttribute('fill', batteryColor(batt));
            c.setAttribute('stroke', '#fff');
            c.setAttribute('stroke-width', '2');
            const title = document.createElementNS(NS, 'title');
            title.textContent = `ID ${r.id}, ${batt !== null && batt !== undefined ? batt + '%' : '—'}`;
            c.appendChild(title);
            layer.appendChild(c);

            const idText = document.createElementNS(NS, 'text');
            idText.setAttribute('class', 'robot-id-text');
            idText.setAttribute('x', x);
            idText.setAttribute('y', y);
            idText.textContent = r.id ?? '';
            layer.appendChild(idText);

            const battText = document.createElementNS(NS, 'text');
            battText.setAttribute('class', 'robot-batt-text');
            battText.setAttribute('x', x);
            battText.setAttribute('y', y + 18);
            battText.textContent = batt !== null && batt !== undefined ? batt + '%' : '—';
            layer.appendChild(battText);
        });
    }

    function renderInventory(items) {
        const tbody = document.getElementById('inventory-body');
        if (!tbody) return;
        const rows = items.map(inv => {
            const dt = inv.scanned_at ? inv.scanned_at.slice(0,16).replace('T',' ') : '—';
            const product = inv.product_name ?? inv.product_id ?? '—';
            return `<tr>
                <td>${dt}</td>
                <td>${inv.robot_id ?? '—'}</td>
                <td>${product}</td>
                <td>${inv.quantity ?? '—'}</td>
                <td>${inv.zone ?? '—'}</td>
                <td>${inv.status ?? '—'}</td>
            </tr>`;
        }).join('');
        tbody.innerHTML = rows || `<tr><td colspan="6" class="empty-msg">Нет данных инвентаризации</td></tr>`;
    }

    let mapScale = 0.2;
    function applyMapScale() {
        const svg = document.getElementById('mapSvg');
        if (svg) svg.style.transform = 'scale(' + mapScale + ')';
    }

    async function refreshData() {
        try {
            const resp = await fetch('{{ url_for("dashboard.data_warehouse") }}', { headers: { 'Accept': 'application/json' } });
            if (!resp.ok) return;
            const data = await resp.json();
            renderRobots(data.robots || []);
            renderInventory(data.inventory || []);
        } catch (e) {
            // silent
        }
    }
    setInterval(refreshData, 5000);
    document.addEventListener('DOMContentLoaded', () => {
        refreshData();
        applyMapScale();
        document.getElementById('zoomIn')?.addEventListener('click', () => { mapScale = Math.min(5, mapScale * 1.2); applyMapScale(); });
        document.getElementById('zoomOut')?.addEventListener('click', () => { mapScale = Math.max(0.1, mapScale * 0.8); applyMapScale(); });
        document.getElementById('zoomReset')?.addEventListener('click', () => { mapScale = 0.2; applyMapScale(); });
        document.querySelector('.map-wrap')?.addEventListener('wheel', (e) => {
            e.preventDefault();
            const factor = e.deltaY > 0 ? 0.9 : 1.1;
            mapScale = Math.max(0.1, Math.min(5, mapScale * factor));
            applyMapScale();
        }, { passive: false });
        document.querySelectorAll('.block[data-url]').forEach(el => {
            el.addEventListener('click', () => {
                const u = el.dataset.url;
                if (u) window.location.href = u;
            });
        });
    });
</script>
{% endblock %}
